SET FOREIGN_KEY_CHECKS = 0;

CREATE DATABASE IF NOT EXISTS dbFitTrack
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

USE dbFitTrack;

CREATE TABLE IF NOT EXISTS Profiles (
    id INT AUTO_INCREMENT PRIMARY KEY,
    `type` VARCHAR(50),
    admin TINYINT(1) DEFAULT 0,
    creation_date DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

INSERT INTO Profiles (`type`, admin, creation_date)
SELECT 'Admin', 1, '2025-12-18 00:33:44'
WHERE NOT EXISTS (SELECT 1 FROM Profiles WHERE `type` = 'Admin');

INSERT INTO Profiles (`type`, admin, creation_date)
SELECT 'User', 0, '2025-12-18 00:33:44'
WHERE NOT EXISTS (SELECT 1 FROM Profiles WHERE `type` = 'User');

CREATE TABLE IF NOT EXISTS Users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255),
    name VARCHAR(255),
    password VARCHAR(500),
    profileId INT,
    creation_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_users_profiles
        FOREIGN KEY (profileId)
        REFERENCES Profiles(id)
        ON DELETE RESTRICT
        ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS Exercises (
    id INT AUTO_INCREMENT PRIMARY KEY,
    userId INT,
    name VARCHAR(500),
    weight DECIMAL(5,2),
    reps INT,
    series INT,
    rest INT,
    obs VARCHAR(500),
    `order` INT,
    creation_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_exercises_users
        FOREIGN KEY (userId)
        REFERENCES Users(id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

ALTER TABLE Users
    ADD COLUMN IF NOT EXISTS bio VARCHAR(500),
    ADD COLUMN IF NOT EXISTS phoneNumber VARCHAR(25);

CREATE TABLE IF NOT EXISTS UserMetrics (
    id INT AUTO_INCREMENT PRIMARY KEY,
    userId INT,
    weight DECIMAL(5,2),
    height DECIMAL(5,2),
    bodyFat DECIMAL(5,2),
    armCircumference DECIMAL(5,2),
    chestCircumference DECIMAL(5,2),
    waistCircumference DECIMAL(5,2),
    legCircumference DECIMAL(5,2),
    weightGoal DECIMAL(5,2),
    workoutsGoal INT,
    CONSTRAINT fk_usermetrics_users
        FOREIGN KEY (userId)
        REFERENCES Users(id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

ALTER TABLE Users
    ADD COLUMN IF NOT EXISTS profilePic VARCHAR(500);

CREATE TABLE IF NOT EXISTS UserWorkouts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    userId INT,
    letter CHAR(2),
    name VARCHAR(255),
    description VARCHAR(500),
    creation_date DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

ALTER TABLE Exercises 
ADD COLUMN IF NOT EXISTS workoutId INT;

SET @fk_exists := (
    SELECT COUNT(*)
    FROM information_schema.TABLE_CONSTRAINTS
    WHERE CONSTRAINT_SCHEMA = DATABASE()
      AND TABLE_NAME = 'Exercises'
      AND CONSTRAINT_NAME = 'FK_Exercises_UserWorkouts'
);

SET @sql := IF(
    @fk_exists = 0,
    'ALTER TABLE Exercises
     ADD CONSTRAINT FK_Exercises_UserWorkouts
     FOREIGN KEY (workoutId)
     REFERENCES UserWorkouts(id)
     ON DELETE CASCADE
     ON UPDATE CASCADE',
    'SELECT 1'
);

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;

CREATE INDEX IF NOT EXISTS idx_users_profileId ON Users(profileId);
CREATE INDEX IF NOT EXISTS idx_users_email ON Users(email);
CREATE INDEX IF NOT EXISTS idx_exercises_userId ON Exercises(userId);
CREATE INDEX IF NOT EXISTS idx_exercises_workoutId ON Exercises(workoutId);
CREATE INDEX IF NOT EXISTS idx_exercises_user_workout ON Exercises(userId, workoutId);
CREATE INDEX IF NOT EXISTS idx_usermetrics_userId ON UserMetrics(userId);
CREATE INDEX IF NOT EXISTS idx_userworkouts_userId ON UserWorkouts(userId);

SET FOREIGN_KEY_CHECKS = 1;
